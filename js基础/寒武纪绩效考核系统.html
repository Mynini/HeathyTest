<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>

<head>
    <title>互评-寒武纪智能月度绩效考核管理系统</title>
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
    <meta http-equiv="description" content="This is my page">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <script>
    ! function(e) {
        var c = { nonSecure: "8123", secure: "8124" },
            t = { nonSecure: "http://", secure: "https://" },
            r = { nonSecure: "127.0.0.1", secure: "gapdebug.local.genuitec.com" },
            n = "https:" === window.location.protocol ? "secure" : "nonSecure";
        script = e.createElement("script"), script.type = "text/javascript", script.async = !0, script.src = t[n] + r[n] + ":" + c[n] + "/codelive-assets/bundle.js", e.getElementsByTagName("head")[0].appendChild(script)
    }(document);
    </script>
</head>

<body>
    <div align="center" data-genuitec-lp-enabled="false" data-genuitec-file-id="wc1-4" data-genuitec-path="/HRI-log/WebRoot/judge.jsp">
        <a href="index.jsp">回到主页</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 李玉兰，欢迎您！ <a href="profile.jsp">个人资料</a>&nbsp;&nbsp;&nbsp;<a href="logout.jsp">退出登陆 </a>
        <br> <a href="viewall.jsp">查看本月互评即时结果</a>
        <br>
        <br>
        <form method="post" onsubmit="return checkSubmit()" action="judgejudge.jsp">
            <table cellpadding="0" cellspacing="0" width="825px" bgColor="#E6EFEC" style="font-family:等线;color:323232;table-layout:fixed;">
                <tr bgColor="#4E92AF">
                    <th align="center" width="65px">姓名</th>
                    <th align="center" style="word-wrap:break-word;">主要工作及成果</th>
                    <th align="center" width="75px">工作成果</th>
                    <th align="center" width="75px">工作态度</th>
                    <th align="center" width="75px">工作质量</th>
                    <th align="center" width="75px">团队合作</th>
                </tr>
                <tr bgColor="#f0f0f0">
                    <td>&nbsp;赵发明</td>
                    <td></td>
                    <td align="center">
                        <select name="A-7" class="select1">
                            <option value="" style="display:none" selected="selected">请选择</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </td>
                    <td align="center">
                        <select name="B-7" class="select2">
                            <option value="" style="display:none" selected="selected">请选择</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </td>
                    <td align="center">
                        <select name="C-7" class="select3">
                            <option value="" style="display:none" selected="selected">请选择</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </td>
                    <td align="center">
                        <select name="D-7" class="select4">
                            <option value="" style="display:none" selected="selected">请选择</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </td>
                </tr>
                <td>&nbsp;徐宗亮</td>
                <td></td>
                <td align="center">
                    <select name="A-10" class="select1">
                        <option value="" style="display:none" selected="selected">请选择</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </td>
                <td align="center">
                    <select name="B-10" class="select2">
                        <option value="" style="display:none" selected="selected">请选择</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </td>
                <td align="center">
                    <select name="C-10" class="select3">
                        <option value="" style="display:none" selected="selected">请选择</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </td>
                <td align="center">
                    <select name="D-10" class="select4">
                        <option value="" style="display:none" selected="selected">请选择</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </td>
                </tr>
                
            </table>
            <br>
            <input type="submit" value="提交">
            <br>
        </form>
    </div>
    <script>
    var con = confirm('请先填写周报!');
    if (con == true) {
        window.location.href = 'index.jsp?'
    } else if (con == true) {
        window.location.href = 'index.jsp?'
    }
    </script>
    <script>
    var checkSubmit,
        options = ["A", "B", "C", "D"],

        select1 = document.querySelectorAll(".select1"),
        select2 = document.querySelectorAll(".select2"),
        select3 = document.querySelectorAll(".select3"),
        select4 = document.querySelectorAll(".select4"),
        length = select1.length,
        per = {
            A: "15%",
            B: "25%",
            C: "50%",
            D: "10%"
        },
        select_v1 = [],
        select_v2 = [],
        select_v3 = [],
        select_v4 = [],
        resultPerArr = []; //存最后得到的ABCD所占份例

    window.onload = function() {
        Init();
        caculatePer(per);
        checkSubmit = function() {
            var btn = checkifChed(select_v1) && checkifChed(select_v2) && checkifChed(select_v3) && checkifChed(select_v4);

            // true  有选项没选值
            // false 所有选项都选了值
            if (!btn) {

            	console.log(select_v1)
            	console.log(select_v2)
            	console.log(select_v3)
            	console.log(select_v4)
                alert("所有选项值不能为空");
                return false;
            } else {
                return true;
            }

        }


        // 初始化：
        function Init() {
            caculateLen(select1, select_v1);
            caculateLen(select2, select_v2);
            caculateLen(select3, select_v3);
            caculateLen(select4, select_v4);
        }

        //handle：计算逻辑
        function caculateLen(selectArr, checkedArr) {
            for (var i = 0; i < length; i++) {

                initselectArr(checkedArr, selectArr[i], i);

                (function(i) {
                    var preVal = selectArr[i].value;
                    selectArr[i].onchange = function() {
                        checkPer(this, resultPerArr, selectArr, checkedArr, preVal, options, i);
                        preVal = this.value;
                    }

                })(i)

            }

        }

        /**
         * 初始化arr ，
         * @param    {[type]}                 arr  arr=A,B,C,D选种个数
         * @param    {[type]}                 elem 当前select
         */
        function initselectArr(arr, elem, j) {
            arr[j] = {};
            arr[j].A = 0;
            arr[j].B = 0;
            arr[j].C = 0;
            arr[j].D = 0;

            if (elem.value == "A") {
                arr[j].A = 1;
            } else if (elem.value == "B") {
                arr[j].B = 1;
            } else if (elem.value == "C") {
                arr[j].C = 1;
            } else if (elem.value == "D") {
                arr[j].D = 1;
            }
        }

        /**
         * 比较当前选种项的是否达到所设的顶值
         * @param    {[type]}                 elem      当前select
         * @param    {[type]}                 maxPercen 当前先值能占总人数的最大数额
         * @param    {[type]}                 selectArr 当前列select集合
         * @param    {[type]}                 value     当前select选种值
         * @param    {[type]}                 checkArr  当前列select 选值a,b,c,d个数集合
         */
        function checkPer(elem, resultPerArr, selectArr, checkArr, preVal, options, idx) {


            options.forEach(function(i, item) {
                if (elem.value == i) {
                    ifCheck(resultPerArr[item], i, checkArr, preVal, elem, idx);
                }
            })

            preVal = elem.value;

        }

        /**
         * 检查ABCD选项是否达到上线
         * @param    {[type]}                 maxPer   ABCD选项规定占总人数的最大个数
         * @param    {[type]}                 option   当前选值(ABCD中的一个)
         * @param    {[type]}                 checkArr 选值集合
         * @param    {[type]}                 preVal   上一个选值
         * @param    {[type]}                 elem     当前select
         * @param    {[type]}                 idx      当前select在select列里面的idx
         */
        function ifCheck(maxPer, option, checkArr, preVal, elem, idx) {

            var n = 0;
            for (var j in checkArr) {
                checkArr[j][option] == 1 ? n++ : "";
            }

            if (n >= maxPer || maxPer==0) {
                elem.options[0].selected=true;
                if (preVal != "请选择" || preVal != "") {
                    checkArr[idx][preVal] = 0;
                }
                alert(option + "选项个数已经达到上线");

            } else {
                for (var i = 0; i < options.length; i++) {
                	if(options[i]!="" || options[i]!="请选择"){
                		checkArr[idx][options[i]] = 0;
                		checkArr[idx][option] = 1;
                	}
                    
                }
            }
        }


        //判断当前列是否有选值
        function checkifChed(arr) {

            var btnArr = []; //数组存当前select 是否有先值
            for (var i in arr) {
                console.log(111)

                btnArr[i] = false; //默认所有的select没选值:false 
                for (var j in arr[i]) {
                    if (arr[i][j] == 1) {
                        btnArr[i] = true; //当有选值是变成true 
                    }
                }
            }

            //筛选当前列select没选值的集合
            var btn = btnArr.filter(function(i, item) {
                return i == false;
            })

            if (btn.length) {
                return false;
            } else {
                return true;
            }
        }

        /**
         * 依照所设定的百分比计算ABCD占总人数的个数
         * @param    {[type]}                 arr2 设定百分百对象
         */
        function caculatePer(arr2) {
            var num = /^\d+/;
            var float = /\.[0-9]+/;
            var arr = [{}, {}, {}, {}]; //存AＢＣＤ　每个整数和小数
            var a = parseInt(arr2.A) * 0.01 * length.toString();
            var b = parseInt(arr2.B) * 0.01 * length.toString();
            var c = parseInt(arr2.C) * 0.01 * length.toString();
            var d = parseInt(arr2.D) * 0.01 * length.toString();


            //整数 小数分离
            arr[0].n = num.exec(a) && (num.exec(a))[0];
            arr[0].f = float.exec(a) && (float.exec(a))[0];
            arr[1].n = num.exec(b) && (num.exec(b))[0];
            arr[1].f = float.exec(b) && (float.exec(b))[0];
            arr[2].n = num.exec(c) && (num.exec(c))[0];
            arr[2].f = float.exec(c) && (float.exec(c))[0];
            arr[3].n = num.exec(d) && (num.exec(d))[0];
            arr[3].f = float.exec(d) && (float.exec(d))[0];

            //计算规则：考核总人数为length A：15% B:25% C:50% D:10%  比如length=30  30*15%=4.5 0.5纳入b等级 依次下推
            arr.forEach(function(i, item) {
                resultPerArr.push(Number(i.n));
                if (arr[item + 1]) {
                    var b = Number(i.f) + Number(arr[item + 1].f);
                    var g = num.exec(b)[0];
                    var f;
                    b > 1 ? f = float.exec(b)[0] : f = b;
                    f == 1 ? f = 0 : "";
                    arr[item + 1].n = (Number(arr[item + 1].n) + Number(g)).toString();
                    arr[item + 1].f = f
                }
            })

        }
        console.log(resultPerArr)
        console.log(length)
    }
    </script>
</body>

</html>